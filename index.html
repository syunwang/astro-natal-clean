<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Astro-Natal | FreeAstrologyAPI + Netlify</title>
  <style>
    :root {
      --c1:#111827; --c2:#1f2937; --c3:#374151; --c4:#4b5563; --c5:#9ca3af; --c6:#e5e7eb; --brand:#7c3aed;
      --ok:#16a34a; --warn:#ef4444;
    }
    html,body{margin:0;padding:0;background:linear-gradient(145deg,#0b1020,#151a2e);color:#e9eefc;font-family:ui-sans-serif,system-ui,"Segoe UI",Roboto,"Microsoft JhengHei",sans-serif}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    h1{font-size:26px;margin:0 0 8px}
    .card{background:rgba(255,255,255,.05);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:18px;margin:14px 0}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    label{font-size:12px;color:#c9d2f3}
    input,select,button,textarea{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);color:#e9eefc;outline:none
    }
    input::placeholder{color:#b7c0e8}
    button{cursor:pointer;border:1px solid rgba(255,255,255,.18);font-weight:600}
    .btn{background:linear-gradient(135deg,#7c3aed,#4f46e5);transition:transform .08s ease}
    .btn:hover{transform:translateY(-1px)}
    .btn-ghost{background:rgba(255,255,255,.06)}
    .muted{color:#aeb8df;font-size:12px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px dashed rgba(255,255,255,.16);padding:8px 10px;text-align:left}
    th{color:#cdd6ff;font-weight:700}
    .ok{color:var(--ok)} .warn{color:var(--warn)}
    .grid-6{grid-column:span 6} .grid-4{grid-column:span 4} .grid-3{grid-column:span 3} .grid-12{grid-column:span 12}
    @media (max-width:900px){.grid-6,.grid-4,.grid-3{grid-column:span 12}}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:rgba(124,58,237,.18);border:1px solid rgba(124,58,237,.35);color:#e9e0ff;font-size:12px}
    .hr{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.16),transparent);margin:12px 0}
    img{max-width:100%;height:auto;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0f1326}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Astro-Natal <span class="badge">Netlify Functions + FreeAstrologyAPI</span></h1>
    <div class="muted">部署網址：<a href="https://astro-natal-clean.netlify.app" target="_blank" rel="noopener">astro-natal-clean.netlify.app</a></div>

    <div class="card">
      <div class="row">
        <div class="grid-6">
          <label>姓名（可選）</label>
          <input id="name" placeholder="例如：Sophia Wang" />
        </div>
        <div class="grid-3">
          <label>出生日期（必填）</label>
          <input id="date" type="date" />
        </div>
        <div class="grid-3">
          <label>出生時間（必填）</label>
          <input id="time" type="time" />
        </div>

        <div class="grid-4">
          <label>語言 lang（必填）</label>
          <select id="lang">
            <option value="zh" selected>zh（中文）</option>
            <option value="en">en（English）</option>
            <option value="es">es（Español）</option>
            <option value="fr">fr（Français）</option>
            <option value="de">de（Deutsch）</option>
            <option value="ja">ja（日本語）</option>
            <option value="ko">ko（한국어）</option>
            <option value="ru">ru（Русский）</option>
            <option value="pt">pt（Português）</option>
            <option value="it">it（Italiano）</option>
          </select>
        </div>

        <div class="grid-4">
          <label>宮位系統 house_system（必填）</label>
          <select id="house_system">
            <option value="placidus" selected>placidus（Placidus）</option>
            <option value="whole_sign">whole_sign（Whole Sign）</option>
            <option value="koch">koch（Koch）</option>
            <option value="equal">equal（Equal）</option>
            <option value="porphyry">porphyry（Porphyry）</option>
            <option value="regiomontanus">regiomontanus（Regiomontanus）</option>
            <option value="campanus">campanus（Campanus）</option>
          </select>
        </div>

        <div class="grid-4">
          <label>時區（IANA，例如 America/Chicago）</label>
          <input id="timezone" placeholder="自填或留空由後端兜底" />
        </div>

        <div class="grid-9">
          <label>出生地（城市/地名關鍵字）</label>
          <input id="place" placeholder="例如：Chicago, IL, USA" />
        </div>
        <div class="grid-3" style="align-self:end">
          <button class="btn-ghost" id="btnGeo">查經緯度</button>
        </div>

        <div class="grid-6">
          <label>緯度 latitude（度）</label>
          <input id="lat" placeholder="e.g. 41.8781" />
        </div>
        <div class="grid-6">
          <label>經度 longitude（度）</label>
          <input id="lon" placeholder="e.g. -87.6298" />
        </div>

        <div class="grid-12 hr"></div>

        <div class="grid-4">
          <button class="btn" id="btnPlanets">取得行星位置</button>
        </div>
        <div class="grid-4">
          <button class="btn" id="btnWheel">產生星盤圖</button>
        </div>
        <div class="grid-4">
          <button class="btn-ghost" id="btnClear">清空輸出</button>
        </div>
      </div>
      <div id="hint" class="muted" style="margin-top:10px"></div>
      <div id="errorBox" style="color:red;font-weight:bold;margin-top:8px"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">行星表格（Planets）</h3>
      <div id="planets"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">星盤圖（Natal Wheel）</h3>
      <div id="wheel"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">診斷訊息</h3>
      <pre id="log" style="background:rgba(0,0,0,.25);padding:12px;border-radius:10px"></pre>
    </div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const el = {
      name: $("#name"), date: $("#date"), time: $("#time"),
      lang: $("#lang"), house_system: $("#house_system"), tz: $("#timezone"),
      place: $("#place"), lat: $("#lat"), lon: $("#lon"),
      btnGeo: $("#btnGeo"), btnPlanets: $("#btnPlanets"), btnWheel: $("#btnWheel"), btnClear: $("#btnClear"),
      planets: $("#planets"), wheel: $("#wheel"), log: $("#log"), hint: $("#hint")
    };

    el.hint.innerText = "必填欄位：日期、時間、緯度、經度、lang、house_system。";

    let lastRequestTime = 0;

    async function fetchPlanets(payload) {
      const now = Date.now();
      if (now - lastRequestTime < 1500) {
        showError("請稍候再試（防止重複呼叫）");
        return;
      }
      lastRequestTime = now;

      try {
        const response = await fetch("/.netlify/functions/freeastro-planets", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (response.status === 429) {
          showError("Too Many Requests，請稍後再試");
          return;
        }

        if (!response.ok) {
          showError(`伺服器錯誤：${response.status}`);
          return;
        }

        const data = await response.json();
        if (data?.input?.utc_offset || data?.input?.tzString) {
          const tzField = document.querySelector("#timezone");
          if (tzField) tzField.value = data.input.tzString || data.input.utc_offset || "+08:00";
        }

        renderPlanets(data);
        toast("行星位置取得成功");
        log(`Planets:\n${JSON.stringify(data, null, 2)}`);
      } catch (err) {
        showError(`連線錯誤：${err.message}`);
      }
    }

    function showError(msg) {
      const box = document.querySelector("#errorBox");
      if (box) box.textContent = msg;
    }

    function toast(msg, level="ok") {
      el.hint.innerHTML = `<span class="${level==='ok'?'ok':'warn'}">${msg}</span>`;
    }

    function log(s){ el.log.textContent = s; }
    function renderPlanets(data){ el.planets.textContent = JSON.stringify(data,null,2); }
  </script>
  <script>
/** ===== 前端通用工具：節流 + 退避重試 ===== **/

// 1) 簡易節流器：同時間只允許 1 個請求在飛；彼此間隔至少 900ms
const requestQueue = [];
let busy = false;
const MIN_GAP_MS = 900;

async function runThrottled(task) {
  return new Promise((resolve, reject) => {
    requestQueue.push({ task, resolve, reject });
    pump();
  });
}

async function pump() {
  if (busy || requestQueue.length === 0) return;
  busy = true;
  const { task, resolve, reject } = requestQueue.shift();
  const start = Date.now();
  try {
    const r = await task();
    const elapsed = Date.now() - start;
    const sleep = Math.max(0, MIN_GAP_MS - elapsed);
    setTimeout(() => {
      busy = false;
      resolve(r);
      pump();
    }, sleep);
  } catch (e) {
    busy = false;
    reject(e);
    pump();
  }
}

// 2) 退避重試：遇到 429/502/503/504 自動重試（0.8s, 1.6s, 3.2s）
async function fetchWithRetry(url, opts = {}, tries = 3, backoff = 800) {
  for (let i = 0; i < tries; i++) {
    const res = await fetch(url, opts).catch(() => null);
    if (res && res.ok) return res;
    const status = res ? res.status : 0;
    if (![429, 502, 503, 504].includes(status)) {
      // 不是可重試的錯誤，直接丟出
      if (res) throw new Error(`${status} ${res.statusText}`);
      throw new Error('network_error');
    }
    // 等待退避
    await new Promise(r => setTimeout(r, backoff));
    backoff *= 2;
  }
  throw new Error('too_many_requests');
}

// 3) 封裝呼叫：用節流器 + 退避重試 打到 Netlify Functions
async function callPlanets(payload) {
  const url = "/.netlify/functions/freeastro-planets";
  const opts = {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  };
  return runThrottled(async () => {
    const res = await fetchWithRetry(url, opts, 3, 800);
    return res.json();
  });
}

// 4) 把按鈕點擊與 callPlanets 綁定（範例）
//   - 你原本的 planets 呼叫，改成用 callPlanets(payload)
window.fetchPlanetsSafe = async function(payload) {
  // 防止連點（可選）
  const btns = document.querySelectorAll("button");
  btns.forEach(b => b.disabled = true);
  try {
    const data = await callPlanets(payload);
    return data; // 外面照舊處理 data
  } catch (e) {
    const box = document.getElementById("diagnose") || document.body;
    const msg = (e.message === 'too_many_requests')
      ? '呼叫過於頻繁，已自動重試但仍被限流，請稍後再試。'
      : `呼叫失敗：${e.message}`;
    console.warn('[planets]', e);
    alert(msg);
    throw e;
  } finally {
    setTimeout(() => btns.forEach(b => b.disabled = false), 600);
  }
};
</script>

</body>
</html>
