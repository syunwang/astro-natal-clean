<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Astro Natal Chart Generator</title>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";
      background:#0b0c10;color:#e6e6e6;margin:0;padding:24px}
    label{display:block;margin:14px 0 6px}
    input,select,button{width:100%;padding:12px;border-radius:10px;border:1px solid #2c2f33;
      background:#12141a;color:#e6e6e6}
    button{background:#6b63ff;border:0;font-weight:700;cursor:pointer}
    pre{background:#0f1115;border:1px solid #222;border-radius:10px;padding:12px;white-space:pre-wrap}
    .row{max-width:820px;margin:0 auto}
  </style>
</head>
<body>
  <div class="row">
    <h1>🪐 Astro Natal Chart Generator</h1>

    <label>姓名 / Name</label>
    <input id="name" placeholder="請輸入姓名或標題 (e.g. Sophia Wang)" />

    <label>地名（例：tainan, taiwan）</label>
    <input id="place" placeholder="tainan, taiwan" />

    <label>語言 lang</label>
    <select id="lang">
      <option value="zh">zh（中文）</option>
      <option value="en">en（English）</option>
    </select>

    <label>宮位系統 house_system</label>
    <select id="house_system">
      <option value="placidus">placidus (Placidus)</option>
      <option value="whole">whole (Whole Sign)</option>
    </select>

    <label>出生時間（24h HH:MM）</label>
    <input id="time" value="20:50" />

    <label>時區（例：8 代表 Asia/Taipei）</label>
    <input id="tzone" value="8" />

    <label>緯度 latitude（度）</label>
    <input id="lat" value="22.9912348" />

    <label>經度 longitude（度）</label>
    <input id="lon" value="120.184982" />

    <br />
    <button id="go">產生星盤圖（行星→輪盤，一鍵）</button>
    <br /><br />
    <button id="clear">清空輸入</button>

    <h3>診斷訊息</h3>
    <pre id="log"></pre>
  </div>

  <script>
    const log = (msg) => {
      const el = document.getElementById('log');
      el.textContent += (typeof msg === 'string' ? msg : JSON.stringify(msg, null, 2)) + '\n';
      el.scrollTop = el.scrollHeight;
    };

    // 時間格式解析
    function parseHM(hhmm) {
      const m = /^(\d{1,2}):(\d{2})$/.exec((hhmm || '').trim());
      if (!m) return null;
      const hour = Number(m[1]), min = Number(m[2]);
      if (hour < 0 || hour > 23 || min < 0 || min > 59) return null;
      return { hour, min };
    }

    document.getElementById('go').addEventListener('click', async () => {
      document.getElementById('log').textContent = '';

      try {
        const name = document.getElementById('name').value.trim();
        const place = document.getElementById('place').value.trim();
        const tzone = Number(document.getElementById('tzone').value);
        const { hour, min } = parseHM(document.getElementById('time').value) || {};

        if (hour === undefined) return log('時間格式錯誤，請用 HH:MM');
        if (Number.isNaN(tzone)) return log('時區需為數字');

        const lat = Number(document.getElementById('lat').value);
        const lon = Number(document.getElementById('lon').value);
        if (Number.isNaN(lat) || Number.isNaN(lon)) return log('請先查好地理，讓經緯度填入');

        const now = new Date();
        const payload = {
          name: name || 'Guest',
          lang: document.getElementById('lang').value,
          house_system: document.getElementById('house_system').value,
          year: now.getFullYear(),
          month: now.getMonth() + 1,
          day: now.getDate(),
          hour,
          min,
          lat,
          lon,
          tzone
        };

        console.log('Sending payload:', payload);
        log(`[${new Date().toLocaleTimeString()}] 呼叫 Planets…`);

        const res = await fetch('/.netlify/functions/freeastro-planets', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        if (!res.ok) {
          log(`❌ HTTP ${res.status} — ${text}`);
        } else {
          try { log(JSON.parse(text)); } catch { log(text); }
        }
      } catch (e) {
        log(e?.message || String(e));
      }
    });

    document.getElementById('clear').addEventListener('click', () => {
      document.getElementById('log').textContent = '';
    });
  </script>
</body>
</html>
