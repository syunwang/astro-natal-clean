<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Astro Natal API</title>
  <style>
    body { font-family: "Segoe UI", system-ui, Arial; margin: 24px; line-height: 1.6; color:#222; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select, button { font-size: 15px; padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; }
    button { cursor: pointer; background:#0ea5e9; color:#fff; border:none; margin-top:6px; }
    button:hover { background:#0284c7; }
    table { border-collapse: collapse; margin-top: 12px; min-width: 700px; }
    th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: left; }
    th { background:#f2f2f2; }
    pre { background:#111; color:#0f0; padding:12px; border-radius:6px; overflow:auto; }
    .error { color:#f43; margin-top:10px; }
    img { max-width: 100%; border:1px solid #ccc; border-radius:8px; margin-top:10px; display:block; }
    .muted { color:#666; font-size:13px; }
  </style>
</head>
<body>
  <h1>Astro Natal API</h1>

  <label>出生日期</label>
  <input id="date" type="date" value="1958-01-07">

  <label>時間 (24h)</label>
  <select id="hour"></select> :
  <select id="minute"></select>

  <label>時區 (UTC Offset)</label>
  <input id="tz" type="number" step="1" value="8">

  <label>地名 (自動轉經緯度)</label>
  <div style="display:flex; gap:8px;">
    <input id="place" style="flex:1" value="Tainan, Taiwan">
    <button id="btnGeo">查詢地名 → 經緯度</button>
  </div>

  <div style="display:flex; gap:8px; margin-top:6px;">
    <div><label>緯度</label><input id="lat" type="number" step="0.0001" value="22.99123"></div>
    <div><label>經度</label><input id="lon" type="number" step="0.0001" value="120.18498"></div>
  </div>

  <div style="margin-top:12px;">
    <button id="btnPlanets">取得行星位置（表格）</button>
    <button id="btnWheel" style="background:#2563eb;">產生星盤圖</button>
    <button id="btnClear" style="background:#dc2626;">清空輸出</button>
  </div>

  <div id="errorBox" class="error" style="display:none;"></div>

  <h3>行星位置表</h3>
  <table id="planetTable">
    <thead>
      <tr><th>行星</th><th>星座</th><th>度數</th><th>逆行</th></tr>
    </thead>
    <tbody id="planetsTbody"></tbody>
  </table>

  <h3>星盤圖</h3>
  <div class="muted">若成功產生，可右鍵另存圖片。</div>
  <img id="wheelImg" alt="星盤" style="display:none">

  <script>
    // 初始化時間下拉
    const hourSel = document.getElementById('hour');
    const minSel = document.getElementById('minute');
    for (let i=0;i<24;i++) hourSel.add(new Option(i.toString().padStart(2,'0'),i));
    for (let i=0;i<60;i++) minSel.add(new Option(i.toString().padStart(2,'0'),i));
    hourSel.value=20; minSel.value=50;

    const errBox = document.getElementById('errorBox');
    const wheelImg = document.getElementById('wheelImg');
    const tbody = document.getElementById('planetsTbody');

    function showError(msg, detail){
      errBox.style.display='block';
      errBox.textContent = msg + (detail ? '：' + JSON.stringify(detail) : '');
    }
    function clearError(){ errBox.style.display='none'; errBox.textContent=''; }

    // 查詢地名轉經緯度
    document.getElementById('btnGeo').onclick = async ()=>{
      clearError();
      const place = document.getElementById('place').value.trim();
      if(!place){ showError('請輸入地名'); return; }
      try{
        const res = await fetch('/.netlify/functions/freeastro-geo',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify({place})
        });
        const data = await res.json();
        if(!res.ok) throw data;
        document.getElementById('lat').value=data.lat;
        document.getElementById('lon').value=data.lon;
        showError('已更新經緯度：' + data.display_name);
      }catch(e){ showError('地名查詢錯誤', e); }
    };

    // 共用：組成輸入 payload
    function getInput(){
      const [y,m,d] = document.getElementById('date').value.split('-').map(Number);
      return {
        year:y, month:m, day:d,
        hours:+hourSel.value, minutes:+minSel.value,
        latitude:+document.getElementById('lat').value,
        longitude:+document.getElementById('lon').value,
        tz:+document.getElementById('tz').value,
        lang:'zh'
      };
    }

    // 清空輸出
    document.getElementById('btnClear').onclick = ()=>{
      clearError(); tbody.innerHTML=''; wheelImg.style.display='none';
    };

    // 取得行星位置（JSON）
    document.getElementById('btnPlanets').onclick = async ()=>{
      clearError();
      const input = getInput();
      try{
        const res = await fetch('/.netlify/functions/freeastro-planets',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify(input)
        });
        const data = await res.json();
        if(!res.ok){ showError('行星資料錯誤', data); return; }

        const list = data.output || data.planets || [];
        const zhName = {
          'Sun':'太陽','Moon':'月亮','Mercury':'水星','Venus':'金星','Mars':'火星',
          'Jupiter':'木星','Saturn':'土星','Uranus':'天王星','Neptune':'海王星','Pluto':'冥王星',
          'Ascendant':'上昇點','Midheaven':'天頂'
        };
        tbody.innerHTML='';
        list.forEach(p=>{
          const tr=document.createElement('tr');
          const name=zhName[p.planet?.en]||p.planet?.en||'';
          const sign=p.zodiac_sign?.name?.zh||p.zodiac_sign?.name?.en||'';
          const deg=(p.normDegree??p.fullDegree??0).toFixed(2);
          const retro=(p.isRetro==='True'||p.isRetro===true)?'是':'否';
          tr.innerHTML=`<td>${name}</td><td>${sign}</td><td>${deg}°</td><td>${retro}</td>`;
          tbody.appendChild(tr);
        });
      }catch(e){ showError('行星資料錯誤', e); }
    };

    // 產生星盤圖
    document.getElementById('btnWheel').onclick = async ()=>{
      clearError();
      const input = getInput();
      try{
        const res = await fetch('/.netlify/functions/freeastro-wheel',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body:JSON.stringify(input)
        });
        if(!res.ok){
          const text = await res.text();
          showError('產生星盤錯誤 ' + res.status, text);
          wheelImg.style.display='none';
          return;
        }
        const blob = await res.blob();
        wheelImg.src = URL.createObjectURL(blob);
        wheelImg.style.display='block';
      }catch(e){ showError('星盤載入失敗', e); }
    };
  </script>
</body>
</html>
