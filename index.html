<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Astro Natal API</title>
  <style>
    :root {
      --bg: #0f1216;
      --fg: #e7eef7;
      --muted: #9fb0c0;
      --panel: #171b21;
      --accent: #4aa8ff;
      --border: #263041;
    }
    html, body {
      background: var(--bg);
      color: var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      margin: 0;
      padding: 0;
    }
    .wrap { max-width: 1100px; margin: 32px auto 64px; padding: 0 20px; }
    h1 { font-size: 28px; margin: 0 0 16px; }
    p.muted { color: var(--muted); margin-top: 0; }

    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin: 16px 0 24px; }

    .grid { display: grid; grid-template-columns: repeat(6, minmax(0, 1fr)); gap: 14px 16px; }
    label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    input, select, button {
      width: 100%; box-sizing: border-box;
      background: #0d1117; color: var(--fg);
      border: 1px solid var(--border); border-radius: 8px;
      padding: 10px 12px; outline: none;
    }
    input:focus, select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px #4aa8ff22; }
    .row-2 { grid-column: span 2 / span 2; }
    .row-3 { grid-column: span 3 / span 3; }
    .row-6 { grid-column: 1 / -1; }

    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      background: linear-gradient(180deg, #1f6feb, #1b62d1); border: 1px solid #1b61d18a;
      padding: 12px 16px; border-radius: 10px; color: #fff; cursor: pointer;
      transition: transform .05s ease; }
    .btn:active { transform: translateY(1px); }
    .btn.secondary { background: #263041; border: 1px solid #2e3b4f; }

    .status { font-size: 13px; color: var(--muted); margin-left: 8px; }

    table { width: 100%; border-collapse: collapse; margin-top: 8px; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
    th, td { padding: 10px 12px; border-bottom: 1px solid var(--border); text-align: left; font-size: 14px; }
    th { background: #121720; color: #cfe6ff; font-weight: 600; }
    tr:last-child td { border-bottom: 0; }

    pre { background: #0d1117; border: 1px solid var(--border); border-radius: 10px; padding: 16px; overflow: auto; white-space: pre-wrap; word-break: break-all; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Astro Natal API</h1>
    <p class="muted">輸入生日與地名資料，點「查詢地名」取得經緯度，再點「產生星盤」。本頁已改為 24 小時制（小時/分鐘兩欄）。</p>

    <!-- 輸入區 -->
    <div class="card">
      <div class="grid">
        <div class="row-2">
          <label>出生日期</label>
          <input id="date" type="date" value="1958-01-07" />
        </div>

        <!-- 兩欄式時間（24h） -->
        <div class="row-2">
          <label>出生時間（24 小時制）</label>
          <div style="display:flex; gap:8px; align-items:center;">
            <input id="hour" type="number" min="0" max="23" step="1" inputmode="numeric" value="20" style="width:100%;">
            <span style="opacity:.6;">:</span>
            <input id="minute" type="number" min="0" max="59" step="1" inputmode="numeric" value="50" style="width:100%;">
          </div>
          <div class="status">範圍：小時 0–23，分鐘 0–59</div>
        </div>

        <div class="row-2">
          <label>時區</label>
          <input id="timezone" type="number" step="0.25" value="8" />
        </div>

        <div class="row-3">
          <label>語言</label>
          <select id="language">
            <option value="en">English</option>
            <option value="zh" selected>中文</option>
          </select>
        </div>

        <div class="row-3">
          <label>地名（自動轉經緯度）</label>
          <div style="display:flex; gap:8px;">
            <input id="place" type="text" placeholder="Tainan, Taiwan" />
            <button id="geoBtn" class="btn secondary" style="width:auto;">查詢地名 → 經緯度</button>
          </div>
          <div id="geoStatus" class="status"></div>
        </div>

        <div class="row-3">
          <label>緯度 Latitude</label>
          <input id="latitude" type="number" step="0.00001" />
        </div>
        <div class="row-3">
          <label>經度 Longitude</label>
          <input id="longitude" type="number" step="0.00001" />
        </div>

        <div class="row-6" style="display:flex; gap:12px; align-items:center; margin-top:8px;">
          <button id="runBtn" class="btn">產生星盤</button>
          <div id="runStatus" class="status"></div>
        </div>
      </div>
    </div>

    <!-- 格式化表格 -->
    <div class="card" id="tableCard" style="display:none;">
      <h3 style="margin-top:0;">格式化結果</h3>
      <table id="resultTable">
        <thead>
          <tr><th>星體</th><th>度數</th><th>星座</th><th>宮位</th><th>逆行</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- 原始 JSON -->
    <div class="card">
      <h3 style="margin-top:0;">原始 JSON（除錯用）</h3>
      <pre id="resultJson">{}</pre>
    </div>
  </div>

  <script>
    // --- Base URL 修復（Netlify / 本機皆可） ---
    const NETLIFY_SITE = "https://astro-natal-clean.netlify.app"; // 你的站點
    const BASE = (location.hostname === "localhost" || location.hostname === "127.0.0.1")
      ? "http://localhost:8888"
      : (location.origin.startsWith("http") ? location.origin : NETLIFY_SITE);

    // --- DOM ---
    const dateEl   = document.getElementById('date');
    const hourEl   = document.getElementById('hour');
    const minuteEl = document.getElementById('minute');
    const tzEl     = document.getElementById('timezone');
    const langEl   = document.getElementById('language');
    const placeEl  = document.getElementById('place');
    const latEl    = document.getElementById('latitude');
    const lonEl    = document.getElementById('longitude');
    const runBtn   = document.getElementById('runBtn');
    const runStatus= document.getElementById('runStatus');
    const geoBtn   = document.getElementById('geoBtn');
    const geoStatus= document.getElementById('geoStatus');
    const resultJson = document.getElementById('resultJson');
    const tableCard  = document.getElementById('tableCard');
    const tableBody  = document.querySelector('#resultTable tbody');

    const SIGN_ZH = ["牡羊","金牛","雙子","巨蟹","獅子","處女","天秤","天蠍","射手","摩羯","水瓶","雙魚"];
    const SIGN_EN = ["Aries","Taurus","Gemini","Cancer","Leo","Virgo","Libra","Scorpio","Sagittarius","Capricorn","Aquarius","Pisces"];
    function signName(idx) {
      const names = langEl.value === 'en' ? SIGN_EN : SIGN_ZH;
      return names[idx % 12] ?? idx;
    }

    // --- API 包裝 ---
    async function callGeo(place) {
      const url = `${BASE}/.netlify/functions/geo?place=${encodeURIComponent(place)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`GEO HTTP ${res.status}`);
      return res.json();
    }

    async function callNatal(payload) {
      const url = `${BASE}/.netlify/functions/natal`;
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(`NATAL HTTP ${res.status}`);
      return res.json();
    }

    // --- 事件：查詢地名 → 經緯度 ---
    geoBtn.addEventListener('click', async () => {
      const place = placeEl.value.trim();
      if (!place) { geoStatus.textContent = "請輸入地名"; return; }
      geoStatus.textContent = "查詢中…";
      try {
        const data = await callGeo(place);
        latEl.value = Number(data.lat).toFixed(5);
        lonEl.value = Number(data.lon).toFixed(5);
        geoStatus.textContent = `OK：${data.display_name}`;
      } catch (e) {
        geoStatus.textContent = "查詢失敗：" + e.message;
      }
    });

    // --- 事件：產生星盤 ---
    runBtn.addEventListener('click', async () => {
      runStatus.textContent = "計算中…";
      tableCard.style.display = "none";
      tableBody.innerHTML = "";

      const [y, m, d] = dateEl.value.split("-").map(Number);

      // 讀兩欄式時間（保證 24h）
      let hh = Number(hourEl.value);
      let mm = Number(minuteEl.value);
      if (isNaN(hh) || isNaN(mm)) { runStatus.textContent = "錯誤：時間格式不正確"; return; }
      if (hh < 0 || hh > 23 || mm < 0 || mm > 59) {
        runStatus.textContent = "錯誤：小時 0–23，分鐘 0–59";
        return;
      }

      // 經緯度處理
      let lat = Number(latEl.value), lon = Number(lonEl.value);
      try {
        if (isNaN(lat) || isNaN(lon)) {
          if (!placeEl.value.trim()) { runStatus.textContent="錯誤：請輸入地名或經緯度"; return; }
          const g = await callGeo(placeEl.value.trim());
          lat = Number(g.lat); lon = Number(g.lon);
          latEl.value = lat.toFixed(5); lonEl.value = lon.toFixed(5);
        }
      } catch (e) {
        resultJson.textContent = JSON.stringify({ error: "GEO 失敗：" + e.message }, null, 2);
        runStatus.textContent = "錯誤";
        return;
      }

      const payload = {
        year: y, month: m, day: d,
        hour: hh, minute: mm,
        latitude: lat, longitude: lon,
        timezone: Number(tzEl.value),
        language: langEl.value
      };

      try {
        const data = await callNatal(payload);
        resultJson.textContent = JSON.stringify(data, null, 2);
        renderTable(data);
        runStatus.textContent = "完成";
      } catch (e) {
        resultJson.textContent = JSON.stringify({ error: String(e) }, null, 2);
        runStatus.textContent = "錯誤";
      }
    });

    // --- 將回傳整理成表格 ---
    function renderTable(resp) {
      let rows = [];
      if (Array.isArray(resp?.output)) {
        const obj = resp.output.find(x => x && typeof x === "object" && !x["0"]);
        if (obj) for (const [k, v] of Object.entries(obj)) rows.push({ name: k, ...v });
      }
      if (!rows.length && resp?.output?.[0]) {
        for (const [k, v] of Object.entries(resp.output[0])) rows.push({ name: v.name ?? k, ...v });
      }
      if (!rows.length) return;

      rows.sort((a, b) => (a.normDegree ?? a.fullDegree) - (b.normDegree ?? b.fullDegree));
      tableBody.innerHTML = rows.map(r => `
        <tr>
          <td>${r.name}</td>
          <td>${(r.normDegree ?? r.fullDegree).toFixed(2)}°</td>
          <td>${signName(r.current_sign)}</td>
          <td>${r.house_number ?? ""}</td>
          <td>${r.isRetro ? "是" : "否"}</td>
        </tr>
      `).join("");

      tableCard.style.display = "";
    }
  </script>
</body>
</html>
