<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>Astro Natal Chart Generator</title>
  <style>
    body { background:#0d0f14; color:#eaeaea; font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans TC', Arial, 'Apple Color Emoji', 'Segoe UI Emoji'; }
    .wrap { max-width: 900px; margin: 40px auto; padding: 0 16px; }
    h1 { font-weight: 700; letter-spacing: .5px; }
    label { display:block; margin: 18px 0 6px; opacity:.85; }
    input, select, button, textarea {
      width: 100%; box-sizing: border-box; padding: 14px 16px; border-radius:12px;
      border: 1px solid #2a2f3a; background: #121620; color: #fff; font-size:16px;
    }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .btn-primary {
      background:#6d5efb; border:1px solid #6d5efb; cursor:pointer; font-weight:700;
    }
    .btn-ghost { background:#1a2030; border:1px solid #2a2f3a; }
    .log { margin-top:18px; padding:16px; background:#0f1220; border-radius:12px; min-height:60px; white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .ok{ color:#57d99b } .warn{ color:#ffce5b } .err{ color:#ff6b6b }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸª Astro Natal Chart Generator</h1>

    <label>å§“å nameï¼ˆå¯é¸ï¼‰</label>
    <input id="name" placeholder="e.g. John Doe" />

    <label>å‡ºç”Ÿæ™‚é–“ï¼ˆ24h HH:MMï¼‰</label>
    <input id="time" placeholder="20:50" value="20:50" />

    <label>æ™‚å€ tzoneï¼ˆä¾‹å¦‚ 8 ä»£è¡¨ Asia/Taipeiï¼‰</label>
    <input id="tzone" type="number" step="0.25" value="8" />

    <label>èªè¨€ lang</label>
    <select id="lang">
      <option value="zh" selected>zhï¼ˆä¸­æ–‡ï¼‰</option>
      <option value="en">enï¼ˆEnglishï¼‰</option>
      <option value="es">esï¼ˆEspaÃ±olï¼‰</option>
      <option value="fr">frï¼ˆFranÃ§aisï¼‰</option>
    </select>

    <label>å®®ä½ç³»çµ± house_system</label>
    <select id="house">
      <option value="placidus" selected>placidusï¼ˆPlacidusï¼‰</option>
      <option value="whole_sign">whole_sign</option>
      <option value="koch">koch</option>
      <option value="equal">equal</option>
    </select>

    <label>åœ°åé—œéµå­—ï¼ˆå…ˆæŸ¥ç¶“ç·¯åº¦ï¼‰</label>
    <div class="row">
      <input id="place" placeholder="tainan, taiwan" />
      <button id="btnGeo" class="btn-ghost">æŸ¥ç¶“ç·¯åº¦</button>
    </div>

    <div class="row">
      <div>
        <label>ç·¯åº¦ latitudeï¼ˆåº¦ï¼‰</label>
        <input id="lat" value="22.9912348" />
      </div>
      <div>
        <label>ç¶“åº¦ longitudeï¼ˆåº¦ï¼‰</label>
        <input id="lon" value="120.184982" />
      </div>
    </div>

    <div class="row" style="margin-top:16px;">
      <button id="btnGo" class="btn-primary">ç”¢ç”Ÿæ˜Ÿç›¤åœ–ï¼ˆè¡Œæ˜Ÿâ†’è¼ªç›¤ï¼Œä¸€éµï¼‰</button>
      <button id="btnClear" class="btn-ghost">æ¸…ç©ºè¼¸å…¥</button>
    </div>

    <div id="log" class="log"></div>
  </div>

<script>
const $ = (id) => document.getElementById(id);
const log = (msg, cls='') => {
  const el = $('log');
  const line = cls ? `<span class="${cls}">${msg}</span>` : msg;
  el.innerHTML = (el.innerHTML ? el.innerHTML + '\n' : '') + line;
};

const toInt = (v) => {
  const n = Number(v);
  return Number.isFinite(n) ? n : undefined;
};

$('btnGeo').addEventListener('click', async () => {
  $('log').innerHTML = '';
  log(`[${new Date().toLocaleTimeString()}] æŸ¥è©¢åœ°ç†â€¦`);
  const q = $('place').value.trim();
  if (!q) { log('è«‹è¼¸å…¥åœ°åé—œéµå­—', 'err'); return; }

  try {
    const res = await fetch('/.netlify/functions/freeastro-geo', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ q })
    });
    const data = await res.json();
    if (!res.ok) {
      log(`åœ°ç†æŸ¥è©¢å¤±æ•—ï¼š${data.message || res.status}`, 'err');
      return;
    }
    const { lat, lon, display_name } = data;
    $('lat').value = String(lat);
    $('lon').value = String(lon);
    log(`åœ°ç†OK: ${display_name}`, 'ok');
  } catch (e) {
    log(`åœ°ç†æŸ¥è©¢ä¾‹å¤–ï¼š${e.message}`, 'err');
  }
});

$('btnGo').addEventListener('click', async () => {
  $('log').innerHTML = '';
  log(`[${new Date().toLocaleTimeString()}] å‘¼å« Planetsâ€¦`);

  // è§£ææ™‚é–“
  const time = $('time').value.trim(); // "HH:MM"
  const [hh, mm] = time.split(':').map((s)=>Number(s));
  if (!Number.isFinite(hh) || !Number.isFinite(mm)) {
    log('æ™‚é–“æ ¼å¼è«‹ç”¨ HH:MMï¼ˆ24hï¼‰', 'err'); return;
  }

  // é€™è£¡ç”¨ä»Šå¤©çš„å¹´æœˆæ—¥ç•¶ç¯„ä¾‹ï¼Œä½ å¯ä»¥æ”¹æˆè®“ä½¿ç”¨è€…è¼¸å…¥æ—¥æœŸ
  const now = new Date();
  const year  = now.getFullYear();
  const month = now.getMonth() + 1;    // 1-12
  const date  = now.getDate();

  const payload = {
    name: $('name').value.trim() || undefined,
    lang: $('lang').value,
    house_system: $('house').value,

    // â€”â€”â€”å®˜æ–¹å¿…å¡«â€”â€”â€”
    year,
    month,
    date,               // âš ï¸ æ˜¯ date ä¸æ˜¯ day
    hour: toInt(hh),
    min:  toInt(mm),    // âš ï¸ æ˜¯ min ä¸æ˜¯ minute
    lat:  Number($('lat').value),
    lon:  Number($('lon').value),
    tzone:Number($('tzone').value),
  };

  // æ¸…æ‰ undefined
  Object.keys(payload).forEach(k => payload[k] === undefined && delete payload[k]);

  console.log('[front] sending payload:', payload);
  log('Sending payloadï¼ˆä¹Ÿå¯«åœ¨ consoleï¼‰');

  try {
    const res = await fetch('/.netlify/functions/freeastro-planets', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload),
    });
    const data = await res.json();
    if (!res.ok) {
      log(`HTTP ${res.status} â€” ${JSON.stringify(data)}`, 'err');
      return;
    }
    log('æˆåŠŸå–å¾—è¡Œæ˜Ÿè³‡æ–™ï¼Œç•¥ã€‚', 'ok');
    // ä½ å¯ä»¥åœ¨é€™è£¡æ¥çºŒå‘¼å« houses / wheel ç­‰â€¦
  } catch (e) {
    log(`ä¾‹å¤–ï¼š${e.message}`, 'err');
  }
});

$('btnClear').addEventListener('click', () => {
  $('name').value = '';
  $('place').value = '';
  $('log').innerHTML = '';
});
</script>
</body>
</html>
