<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Astro Natal Chart Generator</title>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";
      background:#0b0c10;color:#e6e6e6;margin:0;padding:24px}
    label{display:block;margin:14px 0 6px}
    input,select,button{width:100%;padding:12px;border-radius:10px;border:1px solid #2c2f33;
      background:#12141a;color:#e6e6e6}
    button{background:#6b63ff;border:0;font-weight:700;cursor:pointer}
    pre{background:#0f1115;border:1px solid #222;border-radius:10px;padding:12px;white-space:pre-wrap}
    .row{max-width:820px;margin:0 auto}
  </style>
</head>
<body>
  <div class="row">
    <h1>ğŸª Astro Natal Chart Generator</h1>

    <label>å§“å / Name</label>
    <input id="name" placeholder="è«‹è¼¸å…¥å§“åæˆ–æ¨™é¡Œ (e.g. Sophia Wang)" />

    <label>åœ°åï¼ˆä¾‹ï¼štainan, taiwanï¼‰</label>
    <input id="place" placeholder="tainan, taiwan" />

    <label>èªè¨€ lang</label>
    <select id="lang">
      <option value="zh">zhï¼ˆä¸­æ–‡ï¼‰</option>
      <option value="en">enï¼ˆEnglishï¼‰</option>
    </select>

    <label>å®®ä½ç³»çµ± house_system</label>
    <select id="house_system">
      <option value="placidus">placidus (Placidus)</option>
      <option value="whole">whole (Whole Sign)</option>
    </select>

    <label>å‡ºç”Ÿæ™‚é–“ï¼ˆ24h HH:MMï¼‰</label>
    <input id="time" value="20:50" />

    <label>æ™‚å€ï¼ˆä¾‹ï¼š8 ä»£è¡¨ Asia/Taipeiï¼‰</label>
    <input id="tzone" value="8" />

    <label>ç·¯åº¦ latitudeï¼ˆåº¦ï¼‰</label>
    <input id="lat" value="22.9912348" />

    <label>ç¶“åº¦ longitudeï¼ˆåº¦ï¼‰</label>
    <input id="lon" value="120.184982" />

    <br />
    <button id="go">ç”¢ç”Ÿæ˜Ÿç›¤åœ–ï¼ˆè¡Œæ˜Ÿâ†’è¼ªç›¤ï¼Œä¸€éµï¼‰</button>
    <br /><br />
    <button id="clear">æ¸…ç©ºè¼¸å…¥</button>

    <h3>è¨ºæ–·è¨Šæ¯</h3>
    <pre id="log"></pre>
  </div>

  <script>
    const log = (msg) => {
      const el = document.getElementById('log');
      el.textContent += (typeof msg === 'string' ? msg : JSON.stringify(msg, null, 2)) + '\n';
      el.scrollTop = el.scrollHeight;
    };

    // æ™‚é–“æ ¼å¼è§£æ
    function parseHM(hhmm) {
      const m = /^(\d{1,2}):(\d{2})$/.exec((hhmm || '').trim());
      if (!m) return null;
      const hour = Number(m[1]), min = Number(m[2]);
      if (hour < 0 || hour > 23 || min < 0 || min > 59) return null;
      return { hour, min };
    }

    document.getElementById('go').addEventListener('click', async () => {
      document.getElementById('log').textContent = '';

      try {
        const name = document.getElementById('name').value.trim();
        const place = document.getElementById('place').value.trim();
        const tzone = Number(document.getElementById('tzone').value);
        const { hour, min } = parseHM(document.getElementById('time').value) || {};

        if (hour === undefined) return log('æ™‚é–“æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç”¨ HH:MM');
        if (Number.isNaN(tzone)) return log('æ™‚å€éœ€ç‚ºæ•¸å­—');

        const lat = Number(document.getElementById('lat').value);
        const lon = Number(document.getElementById('lon').value);
        if (Number.isNaN(lat) || Number.isNaN(lon)) return log('è«‹å…ˆæŸ¥å¥½åœ°ç†ï¼Œè®“ç¶“ç·¯åº¦å¡«å…¥');

        const now = new Date();
        const payload = {
          name: name || 'Guest',
          lang: document.getElementById('lang').value,
          house_system: document.getElementById('house_system').value,
          year: now.getFullYear(),
          month: now.getMonth() + 1,
          day: now.getDate(),
          hour,
          min,
          lat,
          lon,
          tzone
        };

        console.log('Sending payload:', payload);
        log(`[${new Date().toLocaleTimeString()}] å‘¼å« Planetsâ€¦`);

        const res = await fetch('/.netlify/functions/freeastro-planets', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        if (!res.ok) {
          log(`âŒ HTTP ${res.status} â€” ${text}`);
        } else {
          try { log(JSON.parse(text)); } catch { log(text); }
        }
      } catch (e) {
        log(e?.message || String(e));
      }
    });

    document.getElementById('clear').addEventListener('click', () => {
      document.getElementById('log').textContent = '';
    });
  </script>
</body>
</html>
