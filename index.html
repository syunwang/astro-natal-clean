<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Astro Natal Chart Generator</title>
  <style>
    :root{
      --bg:#0d0d12;
      --panel:#12121a;
      --ink:#e9e9ff;
      --muted:#9aa0a6;
      --accent:#6c63ff;
      --accent-2:#7a6bff;
      --danger:#ff5c7a;
      --good:#2ecc71;
      --radius:14px;
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font:16px/1.5 ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";
    }
    .wrap{max-width:1080px; margin:40px auto; padding:0 20px}
    h1{
      font-weight:800; letter-spacing:.3px; margin:6px 0 22px;
      font-size: clamp(26px, 3.6vw, 40px);
      display:flex; gap:12px; align-items:center;
    }
    .card{
      background:var(--panel); border-radius:var(--radius);
      padding:22px; box-shadow:0 10px 30px rgba(0,0,0,.2);
    }
    .row{display:flex; flex-direction:column; gap:10px; margin:18px 0}
    label{font-weight:700}
    .hint{color:var(--muted); font-size:14px}
    input,select,button,textarea{
      width:100%; box-sizing:border-box;
      padding:14px 16px; border-radius:12px; border:1px solid #2a2a38;
      background:#161625; color:var(--ink); font-size:16px; outline:none;
    }
    input::placeholder{color:#6f7480}
    .actions{display:flex; gap:12px; flex-wrap:wrap; margin-top:16px}
    .btn{
      background:var(--accent); border:none; color:white; font-weight:800; cursor:pointer;
      padding:14px 18px; border-radius:12px; min-width:200px; text-align:center;
    }
    .btn.secondary{background:#23233a}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .grid{display:grid; gap:16px}
    @media (min-width:880px){
      .grid.two{grid-template-columns:1fr 1fr}
    }
    .log{
      white-space:pre-wrap; background:#0f0f17; border-radius:12px; padding:14px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color:#c9ced8; font-size:13px; max-height:280px; overflow:auto; border:1px solid #23233a;
    }
    .ok{color:var(--good)} .bad{color:var(--danger)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>🪐 Astro Natal Chart Generator</h1>

    <div class="card">
      <div class="row">
        <label for="time">出生時間（24h HH:MM）</label>
        <input id="time" type="time" step="60" value="20:50" />
        <div class="hint">若瀏覽器顯示「上午/下午」，也可以直接輸入 08:50 或 20:50，我們會自動轉 24 小時。</div>
      </div>

      <div class="row grid two">
        <div>
          <label for="tz">時區（例如 8 或 Asia/Taipei）</label>
          <input id="tz" inputmode="text" placeholder="建議：8（台灣）或 Asia/Taipei" />
          <div class="actions" style="margin-top:10px">
            <button class="btn secondary" id="btnSuggestTz">自動填入建議</button>
          </div>
          <div class="hint">可填正負整數（如 8、-5），或 IANA 名稱（如 Asia/Taipei）。</div>
        </div>
        <div>
          <label for="lang">語言 lang（必填）</label>
          <select id="lang">
            <option value="zh" selected>zh（中文）</option>
            <option value="en">en（English）</option>
            <option value="ja">ja（日本語）</option>
          </select>
        </div>
      </div>

      <div class="row">
        <label for="house">宮位系統 house_system（必填）</label>
        <select id="house">
          <option value="placidus" selected>placidus（Placidus）</option>
          <option value="whole_sign">whole_sign（Whole Sign）</option>
          <option value="koch">koch（Koch）</option>
        </select>
      </div>

      <div class="row">
        <label for="keyword">地名關鍵字</label>
        <input id="keyword" placeholder="例如：tainan, taiwan" />
        <div class="actions">
          <button id="btnGeo" class="btn secondary">查經緯度</button>
        </div>
      </div>

      <div class="row grid two">
        <div>
          <label for="lat">緯度 latitude（度）</label>
          <input id="lat" placeholder="22.9912348" />
        </div>
        <div>
          <label for="lon">經度 longitude（度）</label>
          <input id="lon" placeholder="120.184982" />
        </div>
      </div>

      <div class="actions">
        <button id="btnOne" class="btn">產生星盤圖（行星→輪盤，一鍵）</button>
        <button id="btnClear" class="btn secondary">清空輸入</button>
      </div>

      <div class="row">
        <label>診斷訊息</label>
        <div id="log" class="log"></div>
      </div>
    </div>
  </div>

<script>
  // 小工具：簡單 log
  const $ = (q)=>document.querySelector(q);
  const logBox = $('#log');
  function log(msg, cls=''){ const t = new Date().toLocaleTimeString(); logBox.innerHTML += `[${t}] ${cls?`<span class="${cls}">`:''}${msg}${cls?'</span>':''}\n`; logBox.scrollTop = logBox.scrollHeight; }
  function setBusy(b=true){ $('#btnOne').disabled=b; $('#btnGeo').disabled=b; }

  // 自動建議時區
  $('#btnSuggestTz').addEventListener('click', ()=>{
    try{
      const tzName = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
      const offsetHrs = -new Date().getTimezoneOffset()/60; // 當前本機偏移（可能有小數）
      // 若偵測為台灣，直接填 8
      if(/taipei/i.test(tzName)) {
        $('#tz').value = '8';
        log(`時區已套用建議：8（偵測到 ${tzName}）`,'ok');
      }else{
        // 取整數偏移
        const v = Math.round(offsetHrs);
        $('#tz').value = String(v);
        log(`時區已套用建議：${v}（偵測到 ${tzName||'未知'}）`,'ok');
      }
    }catch(e){
      $('#tz').placeholder = '8（台灣）或 Asia/Taipei';
      log('無法偵測系統時區，請手動輸入 8 或 Asia/Taipei','bad');
    }
  });

  // 將 "8" 正規化為 "+8"（若後端需要時）
  function normalizeTZ(raw){
    if(!raw) return '';
    const s = String(raw).trim();
    if(/^[-+]/.test(s)) return s;       // +8 / -5
    if(/^[0-9]+$/.test(s)) return `+${s}`; // 8 => +8
    return s; // IANA 名稱
  }

  // 查地理（避免 Missing query）
  $('#btnGeo').addEventListener('click', async ()=>{
    try{
      setBusy(true);
      const q = $('#keyword').value.trim();
      if(!q){ log('請輸入地名關鍵字','bad'); return; }
      log('查詢地理…');

      const res = await fetch('/.netlify/functions/freeastro-geo', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ q })
      });
      if(!res.ok){
        const msg = await res.text();
        throw new Error(`地理查詢失敗：${msg||res.status}`);
      }
      const data = await res.json();
      // 期待回傳格式：{ lat, lon, display_name, ... }
      if(data && data.lat && data.lon){
        $('#lat').value = String(data.lat);
        $('#lon').value = String(data.lon);
        log(`地理 OK：${data.display_name || ''}`,'ok');
      }else{
        log('未取得經緯度，請換一個關鍵字再試','bad');
      }
    }catch(err){
      log(`地理查詢失敗：${err.message}`,'bad');
    }finally{
      setBusy(false);
    }
  });

  // 一鍵（Planets → 你之後可接 Wheel）
  $('#btnOne').addEventListener('click', async ()=>{
    try{
      setBusy(true);
      log('呼叫 Planets…');

      // 擷取欄位
      let time = $('#time').value;         // "20:50"
      const tzRaw = $('#tz').value;
      const tz = normalizeTZ(tzRaw);
      const lang = $('#lang').value || 'zh';
      const house = $('#house').value || 'placidus';
      const lat = parseFloat($('#lat').value || '');
      const lon = parseFloat($('#lon').value || '');

      if(!time){ log('請輸入時間（HH:MM）','bad'); return; }
      if(!tz){ log('請輸入時區（數字或 IANA 名稱）','bad'); return; }
      if(Number.isNaN(lat) || Number.isNaN(lon)){
        log('請先查詢/填寫經緯度','bad'); return;
      }

      // 組裝 body
      const body = {
        name: 'guest',
        lang, house_system: house,
        hour: +time.split(':')[0], minute: +time.split(':')[1],
        lat, lon, tz
      };

      const res = await fetch('/.netlify/functions/freeastro-planets', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });

      if(res.status === 403){
        log('一鍵流程失敗：HTTP 403 Forbidden（疑似 API 金鑰/授權或來源限制，請檢查 Functions 環境變數與供應商白名單）','bad');
        return;
      }
      if(!res.ok){
        const t = await res.text();
        throw new Error(`HTTP ${res.status} ${t || res.statusText}`);
      }
      const data = await res.json();
      log('Planets 成功 ✅','ok');

      // TODO: 若你要接輪盤，再呼叫 /freeastro-wheel
      // 這裡先把 Planet 的少量摘要印出即可
      log(JSON.stringify(data).slice(0, 1200) + (JSON.stringify(data).length>1200?' ...':''));      
    }catch(err){
      log(`一鍵流程失敗：${err.message}`,'bad');
    }finally{
      setBusy(false);
    }
  });

  // 清空
  $('#btnClear').addEventListener('click', ()=>{
    $('#keyword').value='';
    $('#lat').value=''; $('#lon').value='';
    $('#log').innerHTML='';
  });

  // 預設：自動建議時區一次（可拿掉）
  (function autoSuggestOnce(){
    try{
      const tzName = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
      if(/taipei/i.test(tzName)){ $('#tz').value = '8'; }
      else { $('#tz').placeholder = '建議：8（台灣）或 Asia/Taipei'; }
    }catch{}
  })();
</script>
</body>
</html>
