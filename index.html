<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Astro Natal Chart Generator</title>
  <style>
    :root{
      --bg:#0d0d12;
      --panel:#12121a;
      --ink:#e9e9ff;
      --muted:#9aa0a6;
      --accent:#6c63ff;
      --accent-2:#7a6bff;
      --danger:#ff5c7a;
      --good:#2ecc71;
      --radius:14px;
    }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font:16px/1.5 ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";
    }
    .wrap{max-width:1080px; margin:40px auto; padding:0 20px}
    h1{
      font-weight:800; letter-spacing:.3px; margin:6px 0 22px;
      font-size: clamp(26px, 3.6vw, 40px);
      display:flex; gap:12px; align-items:center;
    }
    .card{
      background:var(--panel); border-radius:var(--radius);
      padding:22px; box-shadow:0 10px 30px rgba(0,0,0,.2);
    }
    .row{display:flex; flex-direction:column; gap:10px; margin:18px 0}
    label{font-weight:700}
    .hint{color:var(--muted); font-size:14px}
    input,select,button,textarea{
      width:100%; box-sizing:border-box;
      padding:14px 16px; border-radius:12px; border:1px solid #2a2a38;
      background:#161625; color:var(--ink); font-size:16px; outline:none;
    }
    input::placeholder{color:#6f7480}
    .actions{display:flex; gap:12px; flex-wrap:wrap; margin-top:16px}
    .btn{
      background:var(--accent); border:none; color:white; font-weight:800; cursor:pointer;
      padding:14px 18px; border-radius:12px; min-width:200px; text-align:center;
    }
    .btn.secondary{background:#23233a}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .grid{display:grid; gap:16px}
    @media (min-width:880px){
      .grid.two{grid-template-columns:1fr 1fr}
    }
    .log{
      white-space:pre-wrap; background:#0f0f17; border-radius:12px; padding:14px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color:#c9ced8; font-size:13px; max-height:280px; overflow:auto; border:1px solid #23233a;
    }
    .ok{color:var(--good)} .bad{color:var(--danger)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸª Astro Natal Chart Generator</h1>

    <div class="card">
      <div class="row">
        <label for="time">å‡ºç”Ÿæ™‚é–“ï¼ˆ24h HH:MMï¼‰</label>
        <input id="time" type="time" step="60" value="20:50" />
        <div class="hint">è‹¥ç€è¦½å™¨é¡¯ç¤ºã€Œä¸Šåˆ/ä¸‹åˆã€ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¼¸å…¥ 08:50 æˆ– 20:50ï¼Œæˆ‘å€‘æœƒè‡ªå‹•è½‰ 24 å°æ™‚ã€‚</div>
      </div>

      <div class="row grid two">
        <div>
          <label for="tz">æ™‚å€ï¼ˆä¾‹å¦‚ 8 æˆ– Asia/Taipeiï¼‰</label>
          <input id="tz" inputmode="text" placeholder="å»ºè­°ï¼š8ï¼ˆå°ç£ï¼‰æˆ– Asia/Taipei" />
          <div class="actions" style="margin-top:10px">
            <button class="btn secondary" id="btnSuggestTz">è‡ªå‹•å¡«å…¥å»ºè­°</button>
          </div>
          <div class="hint">å¯å¡«æ­£è² æ•´æ•¸ï¼ˆå¦‚ 8ã€-5ï¼‰ï¼Œæˆ– IANA åç¨±ï¼ˆå¦‚ Asia/Taipeiï¼‰ã€‚</div>
        </div>
        <div>
          <label for="lang">èªè¨€ langï¼ˆå¿…å¡«ï¼‰</label>
          <select id="lang">
            <option value="zh" selected>zhï¼ˆä¸­æ–‡ï¼‰</option>
            <option value="en">enï¼ˆEnglishï¼‰</option>
            <option value="ja">jaï¼ˆæ—¥æœ¬èªï¼‰</option>
          </select>
        </div>
      </div>

      <div class="row">
        <label for="house">å®®ä½ç³»çµ± house_systemï¼ˆå¿…å¡«ï¼‰</label>
        <select id="house">
          <option value="placidus" selected>placidusï¼ˆPlacidusï¼‰</option>
          <option value="whole_sign">whole_signï¼ˆWhole Signï¼‰</option>
          <option value="koch">kochï¼ˆKochï¼‰</option>
        </select>
      </div>

      <div class="row">
        <label for="keyword">åœ°åé—œéµå­—</label>
        <input id="keyword" placeholder="ä¾‹å¦‚ï¼štainan, taiwan" />
        <div class="actions">
          <button id="btnGeo" class="btn secondary">æŸ¥ç¶“ç·¯åº¦</button>
        </div>
      </div>

      <div class="row grid two">
        <div>
          <label for="lat">ç·¯åº¦ latitudeï¼ˆåº¦ï¼‰</label>
          <input id="lat" placeholder="22.9912348" />
        </div>
        <div>
          <label for="lon">ç¶“åº¦ longitudeï¼ˆåº¦ï¼‰</label>
          <input id="lon" placeholder="120.184982" />
        </div>
      </div>

      <div class="actions">
        <button id="btnOne" class="btn">ç”¢ç”Ÿæ˜Ÿç›¤åœ–ï¼ˆè¡Œæ˜Ÿâ†’è¼ªç›¤ï¼Œä¸€éµï¼‰</button>
        <button id="btnClear" class="btn secondary">æ¸…ç©ºè¼¸å…¥</button>
      </div>

      <div class="row">
        <label>è¨ºæ–·è¨Šæ¯</label>
        <div id="log" class="log"></div>
      </div>
    </div>
  </div>

<script>
  // å°å·¥å…·ï¼šç°¡å–® log
  const $ = (q)=>document.querySelector(q);
  const logBox = $('#log');
  function log(msg, cls=''){ const t = new Date().toLocaleTimeString(); logBox.innerHTML += `[${t}] ${cls?`<span class="${cls}">`:''}${msg}${cls?'</span>':''}\n`; logBox.scrollTop = logBox.scrollHeight; }
  function setBusy(b=true){ $('#btnOne').disabled=b; $('#btnGeo').disabled=b; }

  // è‡ªå‹•å»ºè­°æ™‚å€
  $('#btnSuggestTz').addEventListener('click', ()=>{
    try{
      const tzName = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
      const offsetHrs = -new Date().getTimezoneOffset()/60; // ç•¶å‰æœ¬æ©Ÿåç§»ï¼ˆå¯èƒ½æœ‰å°æ•¸ï¼‰
      // è‹¥åµæ¸¬ç‚ºå°ç£ï¼Œç›´æ¥å¡« 8
      if(/taipei/i.test(tzName)) {
        $('#tz').value = '8';
        log(`æ™‚å€å·²å¥—ç”¨å»ºè­°ï¼š8ï¼ˆåµæ¸¬åˆ° ${tzName}ï¼‰`,'ok');
      }else{
        // å–æ•´æ•¸åç§»
        const v = Math.round(offsetHrs);
        $('#tz').value = String(v);
        log(`æ™‚å€å·²å¥—ç”¨å»ºè­°ï¼š${v}ï¼ˆåµæ¸¬åˆ° ${tzName||'æœªçŸ¥'}ï¼‰`,'ok');
      }
    }catch(e){
      $('#tz').placeholder = '8ï¼ˆå°ç£ï¼‰æˆ– Asia/Taipei';
      log('ç„¡æ³•åµæ¸¬ç³»çµ±æ™‚å€ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ 8 æˆ– Asia/Taipei','bad');
    }
  });

  // å°‡ "8" æ­£è¦åŒ–ç‚º "+8"ï¼ˆè‹¥å¾Œç«¯éœ€è¦æ™‚ï¼‰
  function normalizeTZ(raw){
    if(!raw) return '';
    const s = String(raw).trim();
    if(/^[-+]/.test(s)) return s;       // +8 / -5
    if(/^[0-9]+$/.test(s)) return `+${s}`; // 8 => +8
    return s; // IANA åç¨±
  }

  // æŸ¥åœ°ç†ï¼ˆé¿å… Missing queryï¼‰
  $('#btnGeo').addEventListener('click', async ()=>{
    try{
      setBusy(true);
      const q = $('#keyword').value.trim();
      if(!q){ log('è«‹è¼¸å…¥åœ°åé—œéµå­—','bad'); return; }
      log('æŸ¥è©¢åœ°ç†â€¦');

      const res = await fetch('/.netlify/functions/freeastro-geo', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ q })
      });
      if(!res.ok){
        const msg = await res.text();
        throw new Error(`åœ°ç†æŸ¥è©¢å¤±æ•—ï¼š${msg||res.status}`);
      }
      const data = await res.json();
      // æœŸå¾…å›å‚³æ ¼å¼ï¼š{ lat, lon, display_name, ... }
      if(data && data.lat && data.lon){
        $('#lat').value = String(data.lat);
        $('#lon').value = String(data.lon);
        log(`åœ°ç† OKï¼š${data.display_name || ''}`,'ok');
      }else{
        log('æœªå–å¾—ç¶“ç·¯åº¦ï¼Œè«‹æ›ä¸€å€‹é—œéµå­—å†è©¦','bad');
      }
    }catch(err){
      log(`åœ°ç†æŸ¥è©¢å¤±æ•—ï¼š${err.message}`,'bad');
    }finally{
      setBusy(false);
    }
  });

  // ä¸€éµï¼ˆPlanets â†’ ä½ ä¹‹å¾Œå¯æ¥ Wheelï¼‰
  $('#btnOne').addEventListener('click', async ()=>{
    try{
      setBusy(true);
      log('å‘¼å« Planetsâ€¦');

      // æ“·å–æ¬„ä½
      let time = $('#time').value;         // "20:50"
      const tzRaw = $('#tz').value;
      const tz = normalizeTZ(tzRaw);
      const lang = $('#lang').value || 'zh';
      const house = $('#house').value || 'placidus';
      const lat = parseFloat($('#lat').value || '');
      const lon = parseFloat($('#lon').value || '');

      if(!time){ log('è«‹è¼¸å…¥æ™‚é–“ï¼ˆHH:MMï¼‰','bad'); return; }
      if(!tz){ log('è«‹è¼¸å…¥æ™‚å€ï¼ˆæ•¸å­—æˆ– IANA åç¨±ï¼‰','bad'); return; }
      if(Number.isNaN(lat) || Number.isNaN(lon)){
        log('è«‹å…ˆæŸ¥è©¢/å¡«å¯«ç¶“ç·¯åº¦','bad'); return;
      }

      // çµ„è£ body
      const body = {
        name: 'guest',
        lang, house_system: house,
        hour: +time.split(':')[0], minute: +time.split(':')[1],
        lat, lon, tz
      };

      const res = await fetch('/.netlify/functions/freeastro-planets', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });

      if(res.status === 403){
        log('ä¸€éµæµç¨‹å¤±æ•—ï¼šHTTP 403 Forbiddenï¼ˆç–‘ä¼¼ API é‡‘é‘°/æˆæ¬Šæˆ–ä¾†æºé™åˆ¶ï¼Œè«‹æª¢æŸ¥ Functions ç’°å¢ƒè®Šæ•¸èˆ‡ä¾›æ‡‰å•†ç™½åå–®ï¼‰','bad');
        return;
      }
      if(!res.ok){
        const t = await res.text();
        throw new Error(`HTTP ${res.status} ${t || res.statusText}`);
      }
      const data = await res.json();
      log('Planets æˆåŠŸ âœ…','ok');

      // TODO: è‹¥ä½ è¦æ¥è¼ªç›¤ï¼Œå†å‘¼å« /freeastro-wheel
      // é€™è£¡å…ˆæŠŠ Planet çš„å°‘é‡æ‘˜è¦å°å‡ºå³å¯
      log(JSON.stringify(data).slice(0, 1200) + (JSON.stringify(data).length>1200?' ...':''));      
    }catch(err){
      log(`ä¸€éµæµç¨‹å¤±æ•—ï¼š${err.message}`,'bad');
    }finally{
      setBusy(false);
    }
  });

  // æ¸…ç©º
  $('#btnClear').addEventListener('click', ()=>{
    $('#keyword').value='';
    $('#lat').value=''; $('#lon').value='';
    $('#log').innerHTML='';
  });

  // é è¨­ï¼šè‡ªå‹•å»ºè­°æ™‚å€ä¸€æ¬¡ï¼ˆå¯æ‹¿æ‰ï¼‰
  (function autoSuggestOnce(){
    try{
      const tzName = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
      if(/taipei/i.test(tzName)){ $('#tz').value = '8'; }
      else { $('#tz').placeholder = 'å»ºè­°ï¼š8ï¼ˆå°ç£ï¼‰æˆ– Asia/Taipei'; }
    }catch{}
  })();
</script>
</body>
</html>
